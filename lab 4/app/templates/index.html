<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Portfolio Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --border:#e5e7eb; --muted:#6b7280; --bg:#fafafa; --primary:#0d6efd; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px; }
    .bar { display:flex; gap:12px; align-items:center; justify-content:space-between; margin: 8px 0 16px; }
    .btn { border:1px solid var(--border); border-radius:10px; padding:8px 14px; background:#fff; cursor:pointer; }
    .btn.primary { background: var(--primary); border-color: var(--primary); color:#fff; }
    .card { border:1px solid var(--border); border-radius:12px; padding:16px; background:#fff; }
    .muted { color: var(--muted); font-size: 12px; }
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:left; padding:10px; border-bottom:1px solid var(--border); }
    th { background: var(--bg); font-weight:600; }
    .actions { display:flex; gap:8px; }
    .pill { font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; background:#fff; }
    .empty { text-align:center; color: var(--muted); padding:24px 0; }
    @media (max-width: 720px) {
      .hide-sm { display:none; }
      td, th { white-space: nowrap; }
    }
  </style>
</head>
<body>
  <h1>Portfolios</h1>
  <div class="bar">
    <div class="muted">Select a portfolio to manage stocks or run a backtest.</div>
    <div class="actions">
      <button id="btnCreate" class="btn">Create Portfolio</button>
      <button id="btnRefresh" class="btn">Refresh</button>
      <a class="btn primary" href="/backtest">Go to Backtest</a>
    </div>
  </div>

  <div class="card">
    <table>
      <thead>
        <tr>
          <th style="width:90px;">ID</th>
          <th>Name</th>
          <th class="hide-sm">Created</th>
          <th style="width:280px;">Actions</th>
        </tr>
      </thead>
      <tbody id="tbodyPortfolios">
        <tr><td colspan="4" class="empty">Loadingâ€¦</td></tr>
      </tbody>
    </table>
  </div>

<script>
  async function loadPortfolios(){
    const res = await fetch('/api/portfolios');
    const items = await res.json();
    const body = document.getElementById('tbodyPortfolios');
    body.innerHTML = '';
    if(!items.length){
      body.innerHTML = '<tr><td colspan="4" class="empty">No portfolios yet.</td></tr>';
      return;
    }
    for(const p of items){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.id}</td>
        <td>${p.name}</td>
        <td class="hide-sm">${(p.created_at || '').replace('T',' ')}</td>
        <td>
          <div class="actions">
            <a class="btn" href="/portfolio/${p.id}">Manage Stocks</a>
            <a class="btn" href="/backtest?pid=${p.id}">Run Backtest</a>
            <button class="btn" data-del="${p.id}">Delete</button>
            <span class="pill">PID: ${p.id}</span>
          </div>
        </td>`;
      body.appendChild(tr);
    }

    // attach delete handlers
    body.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const pid = e.currentTarget.getAttribute('data-del');
        if(!confirm(`Delete portfolio ${pid}? This will remove its stock list.`)) return;
        const res = await fetch(`/api/portfolio/${pid}`, {method:'DELETE'});
        if(!res.ok){
          const err = await res.json().catch(()=>({error:'Failed'}));
          alert('Error: ' + (err.error || res.statusText));
          return;
        }
        await loadPortfolios();
      });
    });
  }

  document.getElementById('btnRefresh').addEventListener('click', loadPortfolios);
  document.getElementById('btnCreate').addEventListener('click', async () => {
    const name = prompt('New portfolio name:');
    if(!name) return;
    const res = await fetch('/api/portfolio', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ name })
    });
    if(!res.ok){
      const err = await res.json().catch(()=>({error:'Failed'}));
      alert('Error: ' + (err.error || res.statusText));
      return;
    }
    await loadPortfolios();
  });

  // first load
  loadPortfolios();
</script>

</body>
</html>
