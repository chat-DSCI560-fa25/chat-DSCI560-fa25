<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Run Backtest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --border:#e5e7eb; --muted:#6b7280; --bg:#fafafa; --primary:#0d6efd; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px; }
    .bar { display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; justify-content:space-between; margin: 8px 0 16px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    label { font-size:12px; color: var(--muted); display:block; margin-bottom:4px; }
    input, select { padding:8px 10px; border:1px solid var(--border); border-radius:8px; }
    .btn { border:1px solid var(--border); border-radius:10px; padding:10px 16px; background:#fff; cursor:pointer; }
    .btn.primary { background: var(--primary); border-color: var(--primary); color:#fff; }
    .card { border:1px solid var(--border); border-radius:12px; padding:16px; background:#fff; margin-top:14px; }
    .muted { color: var(--muted); font-size: 12px; }
    .kpis { display:grid; grid-template-columns: repeat(3, minmax(160px,1fr)); gap:12px; }
    .kpi { border:1px solid var(--border); border-radius:12px; padding:14px; background:#fff; }
    .kpi .label { font-size:12px; color:var(--muted); }
    .kpi .value { font-size:20px; margin-top:6px; }
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:left; padding:10px; border-bottom:1px solid var(--border); }
    th { background: var(--bg); font-weight:600; }
    .alert { background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; padding:10px 12px; border-radius:10px; margin:10px 0; display:none; }
    @media (max-width: 820px){ .kpis { grid-template-columns: 1fr; } }
    .guidance-box {
    font-size: 12px;
    padding: 10px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: #fafafa;
    color: #6b7280;
    margin-top: 10px;
    display: none; 
  }


  </style>
</head>
<body>
  <h1>Run Backtest</h1>

  <div class="bar">
    <div class="row">

      <div>
        <label for="portfolio">Portfolio</label>
        <select id="portfolio"></select>
      </div>
      <div>
  <label for="strategy">Strategy</label>
  <select id="strategy">
    <option value="sma" selected>SMA Crossover</option>
    <option value="consensus">Consensus Scoring</option>
    <option value="ema_rsi">EMA + RSI Crossover</option> </select>
  </select>
</div>

<div id="smaParams">
  <div>
    <label for="smaShort">SMA Short</label>
    <input id="smaShort" type="number" min="2" step="1" value="10" />
  </div>
  <div>
    <label for="smaLong">SMA Long</label>
    <input id="smaLong" type="number" min="3" step="1" value="30" />
  </div>
</div>
<div id="strategyGuidance" class="guidance-box"></div>
      <div>
        <label for="start">Start</label>
        <input id="start" type="date" />
      </div>
      <div>
        <label for="end">End</label>
        <input id="end" type="date" />
      </div>
      <div>
        <label for="cash">Starting Cash</label>
        <input id="cash" type="number" min="0" step="100" placeholder="10000" />
      </div>
    </div>
    <div class="row">
      <button id="runBtn" class="btn primary">Run Backtest</button>
      <button id="saveBtn" class="btn primary" style="display: none;">Save Session</button>
      <button id="downloadBtn" class="btn" style="display: none;">Download CSV</button>
      <a class="btn" href="/">&larr; Back</a>
    </div>
  </div>
  
  <div id="statusMessage" style="margin-top: 10px; color: green;"></div>
  <div id="err" class="alert"></div>

  <div class="card">
<div class="kpis">
    <div class="kpi">
      <div class="label">Portfolio Value</div>
      <div id="kpiValue" class="value">$–</div>
    </div>
    <div class="kpi">
      <div class="label">Total P&L</div>
      <div id="kpiTotal" class="value">$–</div>
    </div>
    <div class="kpi">
      <div class="label">Total Return</div>
      <div id="kpiReturn" class="value">–%</div>
    </div>
    <div class="kpi">
      <div class="label">CAGR</div>
      <div id="kpiCagr" class="value">–%</div>
    </div>
    <div class="kpi">
      <div class="label">Max Drawdown</div>
      <div id="kpiDrawdown" class="value">–%</div>
    </div>
    <div class="kpi">
      <div class="label">Sharpe Ratio</div>
      <div id="kpiSharpe" class="value">–</div>
    </div>
    <div class="kpi">
      <div class="label">Sortino Ratio</div>
      <div id="kpiSortino" class="value">–</div>
    </div>
    <div class="kpi">
      <div class="label">Calmar Ratio</div>
      <div id="kpiCalmar" class="value">–</div>
    </div>
    <div class="kpi">
        <div class="label">Win Rate</div>
        <div id="kpiWinRate" class="value">–%</div>
    </div>
    <div class="kpi">
        <div class="label">Profit Factor</div>
        <div id="kpiProfitFactor" class="value">–</div>
    </div>
    <div class="kpi">
        <div class="label">Avg Win/Loss</div>
        <div id="kpiWinLoss" class="value">–</div>
    </div>
</div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">Open Positions</h3>
    <table>
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Qty</th>
          <th>Avg Cost</th>
          <th>Last</th>
          <th>Unrealized</th>
        </tr>
      </thead>
      <tbody id="posBody"><tr><td colspan="5" class="muted">Run a backtest to see positions.</td></tr></tbody>
    </table>
  </div>

  <div class="card">
    <h3 style="margin-top:0">Recent Trades</h3>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Symbol</th>
          <th>Side</th>
          <th>Qty</th>
          <th>Price</th>
        </tr>
      </thead>
      <tbody id="tradesBody"><tr><td colspan="5" class="muted">Run a backtest to see trades.</td></tr></tbody>
    </table>
  </div>

  
  
  <script src="/static/js/main.js?v=bt4"></script>

  
  <script>

    function updateUIForStrategy() {
    const strategy = document.getElementById('strategy').value;
    const smaParamsDiv = document.getElementById('smaParams');
    const guidanceDiv = document.getElementById('strategyGuidance');

    if (strategy === 'sma') {
      smaParamsDiv.style.display = 'block';
      const longPeriod = document.getElementById('smaLong').value;
      guidanceDiv.textContent = `For effective results, select a date range longer than your 'SMA Long' period (e.g., > ${longPeriod} days).`;
      guidanceDiv.style.display = 'block';
    } else if (strategy === 'consensus') {
      smaParamsDiv.style.display = 'none';
      guidanceDiv.textContent = 'This strategy uses a 200-day trend filter. For the filter to be active, select a date range of at least one year.';
      guidanceDiv.style.display = 'block';
    } else if (strategy === 'ema_rsi') {
      smaParamsDiv.style.display = 'none';
      guidanceDiv.textContent = "This strategy's longest indicator is a 30-day EMA. For best results, select a date range longer than 30 days.";
      guidanceDiv.style.display = 'block';
    }  
    else {
      smaParamsDiv.style.display = 'none';
      guidanceDiv.style.display = 'none';
    }
  }
    (async function init(){
      // load portfolios 
      await loadPortfolios();

      // preselect pid 
      const url = new URL(window.location.href);
      const qpid = url.searchParams.get('pid') || {{ (pid or 'null') | tojson }};
      if(qpid){
        const sel = document.getElementById('portfolio');
        const opt = [...sel.options].find(o => String(o.value) === String(qpid));
        if(opt) sel.value = opt.value;
      }

      // default dates
      const end = new Date();
      const start = new Date(); start.setDate(end.getDate() - 90);
      const fmt = d => d.toISOString().slice(0,10);
      document.getElementById('end').value = fmt(end);
      document.getElementById('start').value = fmt(start);
      document.getElementById('cash').value = 10000;

      
      const origFetch = window.fetch;
      window.fetch = async (...args) => {
        const res = await origFetch(...args);
        if(!res.ok){
          let msg = 'Failed';
          try { const j = await res.json(); msg = j.error || JSON.stringify(j); } catch{}
          const box = document.getElementById('err');
          box.textContent = msg; box.style.display = 'block';
        } else {
          document.getElementById('err').style.display = 'none';
        }
        return res;
      };
      document.getElementById('strategy').addEventListener('change', updateUIForStrategy);
      updateUIForStrategy();

    })();

  </script>
</body>
</html>
